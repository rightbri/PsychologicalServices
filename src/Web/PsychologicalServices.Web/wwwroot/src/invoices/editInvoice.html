<template>
    <require from="valueConverters/date-format"></require>
    <require from="valueConverters/money"></require>
	<require from="valueConverters/numeric"></require>
	<require from="valueConverters/sort-array"></require>
	<require from="common/validation-summary.html"></require>
	
    <h2>Edit Invoice</h2>

    <div class="container-fluid">
        <div class="row" if.bind="validationErrors">
            <div class="col-xs-12">
                <validation-summary errors.bind="validationErrors"></validation-summary>
            </div>
        </div>
		
		<div class="row">
			<div class="col-xs-2">
				Type:
			</div>
			<div class="col-xs-10">
				${invoice.invoiceType.name} Invoice
			</div>
		</div>
        
        <div class="row">
            <div class="col-xs-2">
                Identifier:
            </div>
            <div class="col-xs-10">
                ${invoice.identifier}
            </div>
        </div>

        <div class="row">
            <div class="col-xs-2">
                Status:
            </div>
            <div class="col-xs-4">
                ${invoice.invoiceStatus.name}
            </div>
			<div class="col-xs-6">
				<button type="button" class="btn btn-default" click.delegate="openInvoice()" if.bind="invoice.invoiceStatus.canOpen">
					Modify
				</button>
				<button type="button" class="btn btn-default" click.delegate="submitInvoice()" if.bind="invoice.invoiceStatus.canSubmit">
					Submit
				</button>
				<button type="button" class="btn btn-default" click.delegate="paidInvoice()" if.bind="invoice.invoiceStatus.canMarkPaid">
					Paid
				</button>
			</div>
        </div>

        <div class="row">
            <div class="col-xs-2">
                Appointments
            </div>
            <div class="col-xs-10">
                <table class="table table-condensed">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>
								<button type="button" class="btn btn-info btn-xs" click.delegate="refreshLines()" if.bind="invoice.invoiceStatus.canEdit">
									<i class="fa fa-refresh"></i>
								</button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
						<template repeat.for="invoiceAppointment of invoice.appointments">
							<tr class="info">
								<td colspan="2">
									${invoiceAppointment.appointment.appointmentTime | dateFormat:config.longDateFormat},
									${invoiceAppointment.appointment.assessment.assessmentType.description} Assessment
									in ${invoiceAppointment.appointment.location.city.name}
									<template repeat.for="claim of invoiceAppointment.appointment.assessment.claims">
									for ${invoiceAppointment.appointment.assessment.referralSource.name}/${claim.claimant.firstName} ${claim.claimant.lastName}
									</template>
								</td>
								<td>
									<button type="button" class="btn btn-info btn-xs" click.delegate="addLine(invoiceAppointment)" if.bind="invoice.invoiceStatus.canEdit">
										<i class="fa fa-plus"></i>
									</button>
								</td>
							</tr>
							<tr repeat.for="line of invoiceAppointment.lines">
								<td>
									<input type="text" class="form-control" value.bind="line.description" disabled.bind="!invoice.invoiceStatus.canEdit" />
								</td>
								<td>
									<input type="number" class="form-control" value.bind="line.amount | money:'0'" change.delegate="calculateTotals()" disabled.bind="!invoice.invoiceStatus.canEdit" />
								</td>
								<td>
									<button type="button" class="btn btn-danger btn-xs" click.delegate="removeLine(invoiceAppointment, line)" if.bind="invoice.invoiceStatus.canEdit">
										<i class="fa fa-times"></i>
									</button>
								</td>
							</tr>
							
							<tr class="warning" if.bind="invoiceAppointment.showStatusLine">
								<td>${invoiceAppointment.appointment.appointmentStatus.name}</td>
								<td>${invoiceAppointment.subtotal | money}</td>
								<td></td>
							</tr>
							
						</template>
					
                        <tr>
                            <td>+ H.S.T.</td>
                            <td>${subtotal * invoice.taxRate | money}</td>
                            <td></td>
                        </tr>

                        <!-- Total Invoice Amount -->
                        <tr>
                            <td>Total Invoice Amount</td>
                            <td>${invoice.total | money}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>

            </div>
        </div>
		
		<div class="row">
			<div class="col-xs-2">
				Documents
			</div>
			<div class="col-xs-10">
				<table class="table table-condensed">
					<thead>
						<tr>
							<th>Document</th>
							<th>Create Date</th>
						</tr>
					</thead>
					<tbody>
						<tr repeat.for="document of invoice.documents | sortArray:{property:'createDate',direction:'desc'}">
							<td>
								<a href="#${document.fileName}" click.delegate="getInvoiceDocument(document)">${document.fileName}</a>
							</td>
							<td>
								${document.createDate | dateFormat:config.longDateTimeFormat}
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		
		<div class="row">
			<div class="col-xs-2">
				Status changes
			</div>
			<div class="col-xs-10">
				<table class="table table-condensed">
					<thead>
						<tr>
							<th>Status</th>
							<th>Date</th>
						</tr>
					</thead>
					<tbody>
						<tr repeat.for="status of invoice.statusChanges | sortArray:{property:'updateDate',direction:'desc'}">
							<td>${status.invoiceStatus.name}</td>
							<td>${status.updateDate | dateFormat:config.longDateTimeFormat}</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

        <div class="row">
            <div class="col-xs-12">
                <button type="button" class="btn btn-default" click.delegate="back()">
                    <i class="fa fa-arrow-left"></i> Back
                </button>
                <button type="button" class="btn btn-primary" click.delegate="save()">
                    Save <i class="fa fa-save"></i>
                </button>
            </div>
        </div>

    </div>

</template>